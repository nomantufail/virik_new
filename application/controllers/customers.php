<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');include_once(APPPATH."controllers/parentController.php");class Customers extends ParentController {    //public variables...    public function __construct()    {        parent::__construct();    }    /* The default function that gets called when visiting the page */    public function index($section='')    {        if($this->login == true){            $name = (isset($_GET['customer']))?$_GET['customer']:'';            $keys = array(                'name'=>$name,            );            //defining the sorting column            $sort = array(                'sort_by'=>(isset($_GET['sort_by']))?$_GET['sort_by']:'entryDate',                'order' => (isset($_GET['order']))?$_GET['order']:'asc',            );            ///////////////////////////////////////////////////////////////            //counting total agents            $num_other_agents = $this->customers_model->count_searched_customers($keys);            $num_other_agents = ($num_other_agents == 0)?1:$num_other_agents;            $config = $this->helper_model->pagination_configs("customers/index/?", "customers", $num_other_agents);            $this->pagination->initialize($config);            $pageNumber = 0;            if(isset($_GET['page'])){                $pageNumber = $_GET['page'];                if($pageNumber>=0){$pageNumber = $pageNumber;}else{ $pageNumber = 0;}            }            $headerData = array(                'title' => 'Virik-Logistics | Customers',                'page' => 'customers',            );            $bodyData = array(                'customers' => '',                'section' => '',                'someMessage' => '',                'pages' => $this->pagination->create_links(),                'columns' => array(),            );            if($section == '' || $section == 'all'){$bodyData['section'] = 'all';}else if($section== 'add'){ $bodyData['section'] = 'add';}            //deleting the customer*****************//            if(isset($_GET['del'])){                $_POST['del'] = $_GET['del'];                $this->form_validation->set_rules('del', 'Customer', 'required|numeric|callback__validate_customer_deleting');                if ($this->form_validation->run() == true)                {                    if( $this->helper_model->delete_record('customers',$_GET['del']) == true){                        $bodyData['someMessage'] = array('message'=>'Customer Deleted Successfully!', 'type'=>'alert-success');                    }else{                        $bodyData['someMessage'] = array('message'=>'Some Unknown database fault happened. please try again a few moments later. Or you can contact your system provider.<br>Thank You', 'type'=>'alert-warning');                    }                }            }            //////////////////////////////////////////////////////////            if(isset($_POST['addCustomer'])){                if($this->form_validation->run('add_customer') == true){                    if( $this->customers_model->add_customer() == true){                        $bodyData['someMessage'] = array('message'=>'Customer Added Successfully!', 'type'=>'alert-success');                    }else{                        $bodyData['someMessage'] = array('message'=>'Some Unknown database fault happened. please try again a few moments later. Or you can contact your system provider.<br>Thank You', 'type'=>'alert-warning');                    }                }            }            $bodyData['customers'] = $this->customers_model->search_limited_customers($config["per_page"], $pageNumber, $keys, $sort);            if(isset($_GET['print'])){                if(isset($_POST['check'])){                    $bodyData['customers'] = $this->helper_model->filter_records($bodyData['customers'], $_POST['check'],"id");                }                if(isset($_POST['column'])){                    $bodyData['columns'] = $_POST['column'];                }                $this->load->view('customers/components/print_customers', $bodyData);            }else{                $this->load->view('components/header', $headerData);                $this->load->view('customers/welcome', $bodyData);                $this->load->view('components/footer');            }        }else{            $this->load->view('admin/login');        }    }    public function profile($c_id = '', $req ='' )    {        if($c_id == ''){            $this->index();        }else{            $headerData = array(                'title' => 'Virik-Logistics | Customers | Profile',                'page' => 'customers',            );            $bodyData = array('profile' => $this->customers_model->customer($c_id),);            $bodyData['customers'] = $this->customers_model->customers();            $footerData = array(                'link'=>'?customer_id='.$c_id,            );            $this->load->view('components/header', $headerData);    //HEADER DATA            //check if we some data received of not against the request?            if($bodyData['profile'] != ''){                $this->load->view('customers/profile', $bodyData);            }else{                $this->load->view('components/recordNotFound');            }            $this->load->view('components/footer', $footerData);     //footer data        }    }    public function tankers($c_id = '', $section ='' )    {        if($c_id == ''){            $this->index();        }else{            $id = (isset($_GET['id']))?$_GET['id']:'';            $tanker_number = (isset($_GET['tanker_number']))?$_GET['tanker_number']:'';            $chase_number = (isset($_GET['chase_number']))?$_GET['chase_number']:'';            $engine_number = (isset($_GET['engine_number']))?$_GET['engine_number']:'';            $capacity = (isset($_GET['capacity']))?$_GET['capacity']:'';            $fitness_certificate = (isset($_GET['certificate']))?$_GET['certificate']:'';            $status = (isset($_GET['status']))?$_GET['status']:'';            $product = (isset($_GET['product']))?$_GET['product']:'';            $customer = $this->customers_model->customer($c_id);            $customer_id = $customer->id;            $keys = array(                'id'=>$id,                'tanker_number'=>$tanker_number,                'chase_number'=>$chase_number,                'engine_number'=>$engine_number,                'capacity'=>$capacity,                'certificate'=>$fitness_certificate,                'status'=>$status,                'product' => $product,                'customer'=>$customer_id,            );            //defining the sorting column            $sort = array(                'sort_by'=>(isset($_GET['sort_by']))?$_GET['sort_by']:'tankers_status_view.id',                'order' => (isset($_GET['order']))?$_GET['order']:'asc',            );            ///////////////////////////////////////////////////////////////            //computing the url for page number            $query_string = explode('&page',$_SERVER['QUERY_STRING']);            $query_string = $query_string[0];            //////////////////////////////////            //counting total agents            $num_other_agents = $this->tankers_model->count_searched_tankers("customerId = ".$c_id);            $num_other_agents = ($num_other_agents == 0)?1:$num_other_agents;            $config = $this->helper_model->pagination_configs("customers/tankers/$c_id/?".$query_string, "tankers", $num_other_agents);            $this->pagination->initialize($config);            $pageNumber = 0;            if(isset($_GET['page'])){                $pageNumber = $_GET['page'];                if($pageNumber>=0){$pageNumber = $pageNumber;}else{ $pageNumber = 0;}            }            $headerData = array(                'title' => 'Virik-Logistics | Customers | Tankers',                'page' => 'customers',            );            $bodyData = array(                'customer' => $customer,                'products' => $this->products_model->get(),                'all_tankers' => $this->db->get_where('tankers',array('customerId'=>$c_id))->result(),                'customers' => [$customer],                'cities'=> $this->routes_model->cities(),                'section' => '',                'someMessage' => '',                'pages' => $this->pagination->create_links(),                'columns' => array(),            );            $footerData = array(                'link'=>'?customer_id='.$c_id,            );            if($section == '' || $section == 'all'){$bodyData['section'] = 'all';}else if($section== 'add'){ $bodyData['section'] = 'add';}            //deleting the Tanker*****************//            if(isset($_GET['del'])){                $_POST['del'] = $_GET['del'];                $this->form_validation->set_rules('del', 'Tanker', 'required|numeric|callback__validate_tanker_deleting');                if ($this->form_validation->run() == true)                {                    if( $this->helper_model->delete_record('tankers',$_GET['del']) == true){                        $bodyData['someMessage'] = array('message'=>'Tanker Deleted Successfully!', 'type'=>'alert-success');                    }else{                        $bodyData['someMessage'] = array('message'=>'Some Unknown database fault happened. please try again a few moments later. Or you can contact your system provider.<br>Thank You', 'type'=>'alert-warning');                    }                }            }            //////////////////////////////////////////////////////////            if(isset($_POST['addTanker'])){                if($this->form_validation->run('add_customer_tanker') == true){                    if( $this->tankers_model->add_tanker($c_id) == true){                        $bodyData['someMessage'] = array('message'=>'Tanker Added Successfully!', 'type'=>'alert-success');                    }else{                        $bodyData['someMessage'] = array('message'=>'Some Unknown database fault happened. please try again a few moments later. Or you can contact your system provider.<br>Thank You', 'type'=>'alert-warning');                    }                }            }            if(isset($_POST['save_tanker'])){                if($this->form_validation->run('edit_tanker') == true){                    if( $this->tankers_model->save_tanker() == true){                        $bodyData['someMessage'] = array('message'=>'Tanker Saved Successfully!', 'type'=>'alert-success');                    }else{                        $bodyData['someMessage'] = array('message'=>'Some Unknown database fault happened. please try again a few moments later. Or you can contact your system provider.<br>Thank You', 'type'=>'alert-warning');                    }                }            }            $bodyData['tankers'] = $this->tankers_model->search_limited_tankers($config["per_page"], $pageNumber, "customerId = ".$c_id);            //$bodyData['customers'] = $this->customers_model->customers();            if(isset($_GET['print'])){                if(isset($_POST['check'])){                    $bodyData['tankers'] = $this->helper_model->filter_records($bodyData['tankers'], $_POST['check'],"id");                }                if(isset($_POST['column'])){                    $bodyData['columns'] = $_POST['column'];                }                $this->load->view('customers/components/print_tankers', $bodyData);            }else{                $this->load->view('components/header', $headerData);                $this->load->view('customers/tankers', $bodyData);                $this->load->view('components/footer', $footerData);            }        }    }    public function accounts($c_id = '', $month ='' )    {        if($c_id == ''){            $this->index();        }else{            $keys['from'] = (isset($_GET['from']))?$_GET['from']:'';            $keys['to'] = (isset($_GET['to']))?$_GET['to']:'';            $keys['trip_id'] = (isset($_GET['trip_id']))?$_GET['trip_id']:'';            $keys['trip_type'] = (isset($_GET['trip_type']))?$_GET['trip_type']:'';            $keys['tanker'] = (isset($_GET['tanker']))?$_GET['tanker']:'';            $keys['entryDate'] = (isset($_GET['entry_date']))?$_GET['entry_date']:'';            $keys['product'] = (isset($_GET['product']))?$_GET['product']:'';            $keys['source'] = (isset($_GET['source']))?$_GET['source']:'';            $keys['destination'] = (isset($_GET['destination']))?$_GET['destination']:'';            $keys['company'] = (isset($_GET['company']))?$_GET['company']:'';            $keys['contractor'] = (isset($_GET['contractor']))?$_GET['contractor']:'';            $keys['cst_freight_unit'] = (isset($_GET['cst_freight_unit']))?$_GET['cst_freight_unit']:'';            $keys['customer_freight_status'] = (isset($_GET['customer_freight_status']))?$_GET['customer_freight_status']:'';            ///////////////////////////////////////////////////////////////            $total_rows = $this->accounts_model->count_searched_customer_accounts($c_id, $keys);            $total_rows = ($total_rows == 0)?1:$total_rows;            /////////////////            //computing the url for page number            $query_string = explode('&page',$_SERVER['QUERY_STRING']);            $query_string = $query_string[0];            //////////////////////////////////            //********Calculating Records/Page***********//            if(isset($_GET['pagination']) && $_GET['pagination'] == 'false'){                $per_page = $total_rows;            }else{                $per_page = 'false';            }            if(isset($_GET['print'])){                $per_page = $total_rows;            }            /////****************************************//            $config = $this->helper_model->pagination_configs("customers/accounts/$c_id/?".$query_string, "", $total_rows, $per_page);            $this->pagination->initialize($config);            $pageNumber = 0;            if(isset($_GET['page'])){                $pageNumber = $_GET['page'];                if($pageNumber>=0){$pageNumber = $pageNumber;}else{ $pageNumber = 0;}            }            //////////////////////////////////////////////////////////////////////////////////            $headerData = array(                'title' => 'Virik Logistics | Customer | Accounts',                'page' => 'customers',            );            if($month == ''){$month = date('Y-m');}            $bodyData = array(                'profile' => $this->customers_model->customer($c_id),                'accounts' => '',                'section' => '',                'someMessage' => '',                'month' => $month,                'columns'=>array(),                'pages'=>$this->pagination->create_links(),            );            if(isset($_POST['add_customer_payment'])){                if($this->form_validation->run('add_customer_payment') == true){                    if( $this->accounts_model->add_customer_payment() == true){                        $bodyData['someMessage'] = array('message'=>'Payment Added Successfully!', 'type'=>'alert-success');                    }else{                        $bodyData['someMessage'] = array('message'=>'Some Unknown database fault accured. please try again a few moments later. Or you can contact your system provider.<br>Thank You', 'type'=>'alert-warning');                    }                }            }            if(isset($_POST['add_mass_payment'])){                if($this->accounts_model->customer_mass_payment($this->input->post('trip_ids')) == true){                    $bodyData['someMessage'] = array('message'=>'Payment Added Successfully!', 'type'=>'alert-success');                }else{                    $bodyData['someMessage'] = array('message'=>'Some Unknown database fault accured. please try again a few moments later. Or you can contact your system provider.<br>Thank You', 'type'=>'alert-warning');                }            }            //deleting account entry            if(isset($_POST['entry_id'])){                if($this->accounts_model->delete_customer_payment($this->input->post('entry_id')) == true){                    $bodyData['someMessage'] = array('message'=>'Payment deleted Successfully!', 'type'=>'alert-success');                }else{                    $bodyData['someMessage'] = array('message'=>'Some Unknown database fault accured. please try again a few moments later. Or you can contact your system provider.<br>Thank You', 'type'=>'alert-warning');                }            }            if(isset($_POST['add_mass_credit'])){                $this->form_validation->set_rules('form_resubmission', 'Form Resubmission', 'required|callback__check_re_submission[voucher_journal]');                if ($this->form_validation->run() == true)                {                    if($this->accounts_model->mass_credit_customer_freight("customers",$c_id) == true){                        $bodyData['someMessage'] = array('message'=>'Payment Added Successfully!', 'type'=>'alert-success');                    }else{                        $bodyData['someMessage'] = array('message'=>'Some Unknown database fault accured. please try again a few moments later. Or you can contact your system provider.<br>Thank You', 'type'=>'alert-warning');                    }                }            }            //saving contractor credit voucher            if(isset($_POST['save_customer_credit_voucher'])){                if($this->accounts_model->save_voucher("customers") == true){                    $bodyData['someMessage'] = array('message'=>'voucher saved Successfully!', 'type'=>'alert-success');                }else{                    $bodyData['someMessage'] = array('message'=>'Some Unknown database fault accured. please try again a few moments later. Or you can contact your system provider.<br>Thank You', 'type'=>'alert-warning');                }            }            $bodyData['accounts'] = $this->accounts_model->customer($c_id, $keys, $config["per_page"], $pageNumber);            $bodyData['companies'] = $this->companies_model->companies();            $bodyData['contractors'] = $this->carriageContractors_model->carriageContractors();            $bodyData['products'] = $this->routes_model->products();            $bodyData['cities'] = $this->routes_model->cities();            $bodyData['customers'] = $this->customers_model->customers();            $bodyData['tankers'] = $this->tankers_model->tankers($c_id);            if(isset($_GET['print'])){                if(isset($_POST['check'])){                    $bodyData['accounts'] = $this->helper_model->filter_records($bodyData['accounts'], $_POST['check'],"trip_id");                }                if(isset($_POST['column'])){                    $bodyData['columns'] = $_POST['column'];                }                $this->load->view('customers/components/print_accounts', $bodyData);            }else{                $this->load->view('components/header', $headerData);                $this->load->view('customers/accounts', $bodyData);                $this->load->view('components/footer');            }        }    }    public function customer_mass_credit($trip_ids)    {        $trip_ids_str = $trip_ids;        $trip_ids = explode('_',$trip_ids_str);        $bodyData = array(            'trips'=>$this->trips_model->parametrized_trips_engine($trip_ids,"customer_accounts"),            'trip_ids_str'=>$trip_ids_str,            'voucher_type'=>1,            'form_id'=>($this->helper_model->last_id('voucher_journal')+1),        );        $this->load->view('customers/components/customer_mass_credit', $bodyData);    }    public function open_customer_credit_voucher_chit($trip_id, $trip_detail_id, $total_credit_amount)    {        $bodyData['trip_id'] = $trip_id;        $bodyData['trip_detail_id'] = $trip_detail_id;        $bodyData['voucher_type'] = 1;        $bodyData['total_creditable_amount'] = $total_credit_amount;        $this->load->view('customers/components/customer_credit_voucher_chit', $bodyData);    }    public function customer_mass_payment($trip_ids)    {        $trip_ids_str = $trip_ids;        $trip_ids = explode('_',$trip_ids_str);        $bodyData = array(            'trips'=>$this->trips_model->test_trips_details($trip_ids),            'trip_ids_str'=>$trip_ids_str,        );        $this->load->view('customers/components/customer_mass_payment', $bodyData);    }    public function add_customer_payment($trip_detail_id, $customer_id, $actual_freight, $remaining){        $bodyData = array(            'previous_payments' => $this->accounts_model->customer_payments($trip_detail_id, $customer_id),            'form_id'=>($this->helper_model->last_id('contractor_accounts')+1),            'trip_detail_id'=>$trip_detail_id,            'customer_id'=>$customer_id,            'actual_freight'=>$actual_freight,            'remaining'=>$remaining,        );        $this->load->view('customers/components/add_customer_payment', $bodyData);    }    public function profit_loss($c_id = '', $from_date='', $to_date='' )    {        if($c_id == ''){            $this->index();        }else{            $headerData = array(                'title' => 'Virik-Logistics | Customers | profit & Loss',                'page' => 'customers',            );            $bodyData = array(                'profile' => $this->customers_model->customer($c_id),                'trips_expenses' => '',                'other_tanker_expenses' => '',                'revenues' => '',                'remaining' => 0,                'paid' => 0,                'total_tanker_expense_trips' => 0,                'total_tanker_expense_other' => 0,                'total_driver_expense_trips' => 0,                'total_pd_expense_trips' => 0,                'total_revenue' => 0,                'total_freight'=> 0,                'from_date' => '',                'to_date' => '',            );            $from = $from_date;            $to = $to_date;            if($from == '' || $to == ''){                $from = date('Y-m')."-01";                $to = date('Y-m')."-".date('t');            }else{                if($this->helper_model->bigger_date(easyDate($from),easyDate($to))){                    $temp_to = $to;                    $to = $from;                    $from = $temp_to;                }                //converting date formats                $to = easyDate($to);                $from = easyDate($from);            }            //computing bodyData            $bodyData['trips_expenses'] = $this->profit_loss_model->customer_trips_expenses($c_id, $from, $to);            foreach($bodyData['trips_expenses'] as $expense){                $bodyData['total_tanker_expense_trips'] += $expense->tanker_expense;                $bodyData['total_driver_expense_trips'] += $expense->drivers_expense;                $bodyData['total_pd_expense_trips'] += $expense->pd_expense;            }            $bodyData['other_tanker_expenses'] = $this->profit_loss_model->customer_other_tanker_expenses($c_id, $from, $to);            foreach($bodyData['other_tanker_expenses'] as $expense){                $bodyData['total_tanker_expense_other'] += $expense->amount;            }            $bodyData['revenues'] = $this->profit_loss_model->customer_trips_revenues($c_id, $from, $to);            foreach($bodyData['revenues'] as $revenue){                $bodyData['total_freight'] += $revenue->total_freight;                $bodyData['total_revenue'] += $revenue->net_freight;                $bodyData['paid'] += $revenue->paid;                $bodyData['remaining'] += $revenue->remaining;            }            $bodyData['from_date']=$from;            $bodyData['to_date']=$to;            if(isset($_GET['print'])){                $this->load->view('customers/components/print_profit_loss', $bodyData);            }else{                $this->load->view('components/header', $headerData);                $this->load->view('customers/profit_loss', $bodyData);                $this->load->view('components/footer');            }        }    }    public function contact($c_id = '', $req ='' )    {        if($c_id == ''){            $this->index();        }else{            $headerData = array(                'title' => 'Virik-Logistics | Customers | Accounts',                'page' => 'customers',            );            $bodyData = array(                'contacts' => $this->accounts_model->customer($c_id),            );            $this->load->view('components/header', $headerData);    //HEADER DATA            //check if we some data received of not against the request?            if($bodyData['contacts'] != ''){                $this->load->view('customers/contact', $bodyData);            }else{                $this->load->view('components/recordNotFound');            }            $this->load->view('components/footer');     //footer data        }    }    public function add_payment($trip_detail_id, $customer_id, $freight){        $bodyData = array(            'previous_payments' => $this->accounts_model->customer_payments($trip_detail_id, $customer_id),            'form_id'=>($this->helper_model->last_id('customer_accounts')+1),            'trip_detail_id'=>$trip_detail_id,            'customer_id'=>$customer_id,            'freight'=>$freight,        );        $this->load->view('customers/components/add_payment', $bodyData);    }    public function home()    {    }    function _create_captcha(){        /*$words = array( '2', '3', '4', '5', '6','7', '8', '9','0', 'a', 'b','z', 'n', 'b','x', 'y', 'v');        $count = 1;        $word = "";        while($count < 3){            $word = $word.$words[mt_rand(0, 16)];            $count++;        }        $vals = array(            'word'      => strtolower($word),            'img_path'	=> './captcha/',            'img_url'	=> base_url().'captcha/',            'font_path'	=> 'fonts/DENMARK.ttf',            'img_width'	=> '210',            'img_height' => 40,            'expiration' => 20        );        $cap = create_captcha($vals);        return $cap;*/    }    function _validate_customer_payment_amount($amount){        $previous_payments = $this->accounts_model->customer_payments($this->input->post('trip_detail_id'), $this->input->post('customer_id'));        $paid = 0;        foreach($previous_payments as $payment){            $paid+= $payment->amount;        }        if($amount > $this->input->post('actual_freight')-$paid){            $this->form_validation->set_message('_validate_customer_payment_amount','Entry failed because of Invalid Freight Amount. Please try again.');            return false;        }        return true;    }    function _validate_customer_deleting($customer_id){        $used_in = '';        $tankers = $this->db->get_where('tankers',array('customerId'=>$customer_id))->num_rows();        if($tankers >=1){            $used_in = 'Tankers, ';        }        $trips = $this->db->get_where('trips',array('customer_id'=>$customer_id, 'active'=>1))->num_rows();        if($trips >=1){            $used_in = 'Trips, ';        }        $this->db->from('voucher_journal');        $this->db->join('voucher_entry','voucher_entry.journal_voucher_id = voucher_journal.id','left');        $where = "(voucher_journal.person_tid = 'customers.".$customer_id."' OR voucher_entry.related_customer = ".$customer_id.")";        $this->db->where($where);        $this->db->where('voucher_journal.active',1);        $accounts = $this->db->get()->num_rows();        if($accounts >= 1){            $used_in .= 'Accounts, ';        }        if($used_in != ''){            $this->form_validation->set_message('_validate_customer_deleting','This Customer is being used in the other parts of the system! e.g('.$used_in.').');            return false;        }        return true;    }    function _validate_tanker_deleting($tanker_id){        $used_in = '';        $trips = $this->db->get_where('trips',array('tanker_id'=>$tanker_id, 'active'=>1))->num_rows();        if($trips >=1){            $used_in = 'Trips, ';        }        $this->db->from('voucher_journal');        $this->db->where('voucher_journal.active',1);        $this->db->where(array(            'voucher_journal.tanker_id'=>$tanker_id,        ));        $accounts = $this->db->get()->num_rows();        if($accounts >= 1){            $used_in .= 'Accounts';        }        if($used_in != ''){            $this->form_validation->set_message('_validate_tanker_deleting','This Tanker is being used in the other parts of the system! e.g('.$used_in.').');            return false;        }        return true;    }    function _check_credentials($str, $data){        /*list($table, $userField, $passField)=explode('.', $data);        //You have to change this line below        if($this->input->post('username') != "" && $this->input->post('password') != "" && $this->input->post('confirmCaptcha') != "" && $this->form_validation->captcha_check($this->input->post('confirmCaptcha'), 'captcha') == true){            //////////////////////////////////////////////////////////////////////////////////////////////////            $userName = $userField.".".$this->input->post('username');            $password = $passField.".".$this->input->post('password');            $credentials = $this->admin_model->check_credentials($table, $userName, $password);            if($credentials == false){                $this->form_validation->set_message('_check_credentials','Invalid Username/Password. Please try again');                return false;            }else{                return true;            }        }else{            return true;        }*/    }    function _check_re_submission($form_id, $table){        if($this->helper_model->re_submission($table, $form_id) == true){            $this->form_validation->set_message('_check_re_submission','Entry failed because of form re-submission.');            return false;        }        return true;    }}/* End of file welcome.php *//* Location: ./application/controllers/welcome.php */