<div class="contractor_credit_voucher_popup" style="background-color: #ffffff;"><script>    function display_row(){        var pannel_count = document.getElementById("pannel_count");        var row_id = "row_"+pannel_count.value;        document.getElementById(row_id).style.display='';        document.getElementById(row_id).style.width='100%';        pannel_count.value = parseInt(pannel_count.value)+1;        //we think that when a new row is added we should re_populate the form...        //i_think_route_changed(0,pannel_count.value-1);    }    function hide_row(){        var pannel_count = document.getElementById("pannel_count");        var decrease_count = parseInt(pannel_count.value)-1;        var row_id = "row_"+decrease_count;        if(pannel_count.value > 3){            document.getElementById(row_id).style.display='none';            pannel_count.value = parseInt(pannel_count.value)-1;        }    }    function fetch_agents(agent,area_id, callback){        var agents_area = document.getElementById("agent_id_area_"+area_id);        $.get("<?=base_url()."accounts/fetch_agents/"?>"+agent+"/"+area_id+"/"+"scrap",function(data,status){            agents_area.innerHTML= data;            callback();        });    }    function fetch_tankers(trip_id, customer_id, callback){        var tankers_area = document.getElementById("voucher_tankers_area");        tankers_area.innerHTML = ".....";        var requested_tanker = document.getElementById("requested_tanker").value;        requested_tanker = (requested_tanker == '')?'none':requested_tanker;        $.get("<?=base_url()."accounts/fetch_tankers/"?>"+trip_id+"/"+customer_id+"/"+requested_tanker,function(data,status){            tankers_area.innerHTML= data;            callback();        });    }    function fetch_customers(trip_id, callback){        var customers_area = document.getElementById("voucher_customers_area");        customers_area.innerHTML = ".....";        var requested_customer = document.getElementById("requested_customer").value;        requested_customer = (requested_customer == '')?'none':requested_customer;        $.get("<?=base_url()."accounts/fetch_customers/"?>"+trip_id+"/"+requested_customer ,function(data,status){            customers_area.innerHTML= data;            callback();        });    }    function i_think_trip_changed()    {        var tankers_area = document.getElementById("voucher_tankers_area");        tankers_area.innerHTML = ".....";        var customers_area = document.getElementById("voucher_customers_area");        customers_area.innerHTML = ".....";        trip_id = document.getElementById('trip_id').value;        if(trip_id == '' || trip_id < 1){            trip_id = "null";            fetch_customers(trip_id, function(){                i_think_customer_changed();            })        }else{            trip_id = parseInt(trip_id);            fetch_tankers(trip_id,'null', function() {                fetch_customers(trip_id, function(){                })            });        }    }    function i_think_customer_changed()    {        var customers_selected_index = document.getElementById("customers").selectedIndex;        var customer_id = document.getElementById("customers").options[customers_selected_index].value;        fetch_tankers('null', customer_id, function(){            //nothing here..        });    }    function amount_changed()    {        var balance_target = document.getElementById('voucher_balance');        var pannel_count = document.getElementById("pannel_count");        var debit_amount = 0;        var credit_amount = 0;        for(var count = 0; count<(pannel_count.value-1); count++){            var amount = document.getElementsByClassName("amount")[count].value;            amount = (amount == '')?0:parseFloat(amount);            var payment_type_selected_index = document.getElementsByClassName("payment_type")[count].selectedIndex;            var payment_type = document.getElementsByClassName("payment_type")[count].options[payment_type_selected_index].value;            if(payment_type == '1'){                debit_amount = debit_amount+amount;            }else{                credit_amount += amount;            }        }        var balance = debit_amount - credit_amount;        balance_target.innerHTML =balance;    }    function agent_type_changed(area_id)    {        var id = "agent_type_"+area_id;        var agent_type_selected_index = document.getElementById(id).selectedIndex;        var agent_type = document.getElementById(id).options[agent_type_selected_index].value;        if(agent_type != ''){            document.getElementById('agent_id_area_'+area_id).innerHTML = '<span style="font-size:12px; font-style: italic; color: gray;">Loading...</span>';            fetch_agents(agent_type, area_id,function(){            });        }else{            document.getElementById('agent_id_area_'+area_id).innerHTML = '';        }    }    //here is the stuff we do when document is ready...    $( document ).ready(function() {        //i_think_trip_changed();        amount_changed();    });    function validate_voucher_form()    {        if(parseInt(document.getElementById("voucher_balance").innerHTML) != 0){            document.getElementById("balance_area").className+=' some_problem';            alert("Balance in not zero...\n please recheck your entries.");            return false;        }        var pannel_count = document.getElementById("pannel_count");        var total_debits = 0;        var total_credits = 0;        var credit_amount = 0;        for(var count = 0; count<(pannel_count.value-1); count++){            var payment_type = document.getElementsByClassName("payment_type")[count].selectedIndex;            var payment_type_value = document.getElementsByClassName("payment_type")[count].options[payment_type].value;            if(payment_type_value == 1){                total_debits++;            }else if(payment_type_value == 0){                credit_amount += parseInt(document.getElementsByClassName("amount")[count].value);                total_credits++;            }        }        if(total_credits == 0){            alert("WARNING!\nAll entries cannot be debit.\nAtleast one of them should be credit.");            return false;        }        if(total_debits == 0){            alert("WARNING!\nAll entries cannot be credit.\nAtleast one of them should be debit.");            return false;        }        if(credit_amount > <?= $total_creditable_amount ?>){            alert("ERROR!\nCredit Amount should not be greater than <?= $total_creditable_amount ?>.");            return false;        }        return true;    }</script><style>    .voucher_title{        font-size: 18px;        font-weight: bold;        color: #0088cc;    }    .voucher_date{        font-weight: bold;        font-size: 14px;    }    .voucher_form input{        height: 25px;    }    .un_balanced{        color: red;    }    .some_problem{        border: 2px dashed red;    }</style><div class="row"><form method="post" class="voucher_form" onsubmit="return validate_voucher_form()"><!--hidden fields--><input type="hidden" name="trip_detail_id" value="<?= $voucher->trip_detail_id ?>"><!--*********--><div class="col-lg-12"><div class="col-sm-12" style="border: 0px solid red;">    <div class="voucher_title col-sm-6">Voucher #<?= $voucher->voucher_id ?><input type="hidden" name="voucher_id" value="<?= $voucher->voucher_id; ?>"></div>    <div class="voucher_date col-sm-6 text-right"><input type="date" value="<?= $voucher->voucher_date; ?>" name="voucher_date" required="required"></div></div><div class="col-lg-12" style="overflow-x: auto; border: 0px solid red;">    <table class="table table-bordered"  style="font-size: 12px; overflow: auto;">        <tr>            <td>                <input type="hidden" value="" name="form_id">                <div>                    <div class="col-sm-4"><span style="font-size: 14px; font-weight: bold;">Tanker# </span>                                    <span id="voucher_tankers_area">                                        <select name="tankers">                                            <?php foreach($tankers as $tanker): ?>                                                <option value="<?= $tanker->id ?>" <?= (($voucher->tanker_id == $tanker->id)?'selected':'') ?>><?= $tanker->truck_number ?></option>                                            <?php endforeach; ?>                                            <option value="">None</option>                                        </select>                                    </span>                    </div>                    <div class="col-sm-3"><span style="font-size: 14px; font-weight: bold;">Trip ID: </span><span><input type="number" value="<?= $voucher->trip_id; ?>" name="trip_id" id="trip_id" min="0" max="<?= $max_trip_id ?>"></span></div>                    <div class="col-sm-5"><span style="font-size: 14px; font-weight: bold;">Contractor: </span>                        <span id="voucher_customers_area">                                        <select name="account_holders">                                            <?php foreach($account_holders as $account_holder): ?>                                                <?php                                                $selected = ($account_holder->id == $voucher->person_id)?'selected':'';                                                ?>                                                <option <?= $selected ?> value="<?= $account_holder->id ?>"><?= $account_holder->name ?></option>                                            <?php endforeach; ?>                                        </select>                                </span>                    </div>                </div>            </td>        </tr>        <tr>            <td>                <div class="panel-body">                    <table style="font-size: 12px;" class="product_details_table table">                        <thead>                        <tr id="">                            <th>Tr_Type</th>                            <th>Tr_Title</th>                            <th>Description</th>                            <th>Agent</th>                            <th>Amount</th>                            <th>Dr/Cr</th>                        </tr>                        </thead>                        <tbody>                        <?php $row_counter = 0; ?>                        <?php foreach($voucher->entries as $voucher_entry): ?>                            <?php $row_counter++; ?>                            <tr id="row_<?= $row_counter ?>" style="display:visible; width: 100%;">                                <td>                                    <input type="hidden" name="voucher_entry_id_<?= $row_counter ?>" value="<?= $voucher_entry->id; ?>">                                    <select name="<?= "tr_type_".$row_counter; ?>">                                        <option value="expense" <?= (($voucher_entry->ac_type == 'expense')?'selected':''); ?> >Expense</option>                                        <option value="payable" <?= (($voucher_entry->ac_type == 'payable')?'selected':''); ?> >Payable</option>                                        <option value="receivable" <?= (($voucher_entry->ac_type == 'receivable')?'selected':''); ?> >Receivable</option>                                        <option value="revenue" <?= (($voucher_entry->ac_type == 'revenue')?'selected':''); ?> >Revenue</option>                                        <option value="bank" <?= (($voucher_entry->ac_type == 'bank')?'selected':''); ?>>Bank</option>                                        <option value="owner_equity" <?= (($voucher_entry->ac_type == 'owner_equity')?'selected':''); ?>>Owner Equity</option>                                        <option value="assets" <?= (($voucher_entry->ac_type == 'assets')?'selected':''); ?>>Assets</option>                                        <option value="retain_earning" <?= (($voucher_entry->ac_type == 'retain_earning')?'selected':''); ?>>Retain Earning</option>                                        <option value="liability" <?= (($voucher_entry->ac_type == 'liability')?'selected':''); ?>>Liability</option>                                        <option value="dividend" <?= (($voucher_entry->ac_type == 'dividend')?'selected':''); ?>>Dividend</option>                                        <option value="revenue" <?= (($voucher_entry->ac_type == 'revenue')?'selected':''); ?>>Revenue</option>                                    </select>                                </td>                                <td>                                    <select style="width: 100px;" name="<?= "tr_title_".$row_counter; ?>">                                        <?php                                        foreach($titles as $title)                                        {                                            $selected = ($voucher_entry->account_title_id == $title->id)?"selected":'';                                            echo"<option value=".$title->id." $selected>".$title->title."</option>";                                        }                                        $selected = ($voucher_entry->account_title_id == '')?'selected':'';                                        ?>                                    </select>                                </td>                                <td>                                    <input type="text" value="<?= $voucher_entry->description; ?>" placeholder="other info..." name="<?= "description_".$row_counter; ?>">                                </td>                                <td>                                    <select class="agent_type" onchange="agent_type_changed(<?= $row_counter ?>)" id="<?= "agent_type_".$row_counter; ?>" name="<?= "agent_type_".$row_counter; ?>">                                        <option value="other_agents" <?= ($voucher_entry->related_agent == 'other_agents')?'selected':'' ?> >Other Agent</option>                                        <option value="customers" <?= ($voucher_entry->related_agent == 'customers')?'selected':'' ?> >Customer</option>                                        <option value="carriage_contractors" <?= ($voucher_entry->related_agent == 'carriage_contractors')?'selected':'' ?> >Contractor</option>                                        <option value="companies" <?= ($voucher_entry->related_agent == 'companies')?'selected':'' ?> >Company</option>                                        <option value="" <?= ($voucher_entry->related_agent == 'self')?'selected':'' ?> >Self</option>                                    </select>                                                <span id="<?= "agent_id_area_".$row_counter; ?>">                                                    <?php if($voucher_entry->related_agent != 'self'): ?>                                                        <select name="<?= "agent_id_".$row_counter; ?>">                                                            <?php                                                            foreach($voucher_entry->related_agents_list as $agent)                                                            {                                                                $selected = ($voucher_entry->related_agent_id == $agent->id)?"selected":'';                                                                echo"<option value=".$agent->id." $selected>".$agent->name."</option>";                                                            }                                                            ?>                                                        </select>                                                    <?php endif; ?>                                                </span>                                </td>                                <td><input id="amount" value="<?= (($voucher_entry->dr_cr == 'credit')?$voucher_entry->credit:$voucher_entry->debit); ?>" onkeyup="amount_changed()" onchange="amount_changed()" type="number" step="any" max="<?= $total_creditable_amount ?>" class="amount" name="<?= "amount_".$row_counter; ?>" placeholder="amount.."></td>                                <td>                                    <select class="payment_type" onchange="amount_changed()" name="<?= "payment_type_".$row_counter; ?>">                                        <option value="1" <?= (($voucher_entry->dr_cr == 'debit')?'selected':''); ?> >Debit</option>                                        <option value="0" <?= (($voucher_entry->dr_cr == 'credit')?'selected':''); ?> >Credit</option>                                    </select>                                </td>                            </tr>                        <?php endforeach; ?>                        <?php                        for($row_counter = sizeof($voucher->entries)+1; $row_counter<9; $row_counter++){                            ?>                            <tr id="row_<?= $row_counter ?>" style="display:none; width: 100%;">                                <td>                                    <input type="hidden" name="voucher_entry_id_<?= $row_counter ?>" value="0">                                    <select name="<?= "tr_type_".$row_counter; ?>">                                        <option value="expense">Expense</option>                                        <option value="payable">Payable</option>                                        <option value="receivable">Receivable</option>                                        <option value="bank">Bank</option>                                        <option value="owner_equity">Owner Equity</option>                                        <option value="assets">Assets</option>                                        <option value="retain_earning">Retain Earning</option>                                        <option value="liability">Liability</option>                                        <option value="dividend">Dividend</option>                                        <option value="revenue">Revenue</option>                                    </select>                                </td>                                <td>                                    <select style="width: 100px;" name="<?= "tr_title_".$row_counter; ?>">                                        <?php                                        foreach($titles as $title)                                        {                                            echo"<option value=".$title->id.">".$title->title."</option>";                                        }                                        ?>                                    </select>                                </td>                                <td>                                    <input type="text" placeholder="other info..." name="<?= "description_".$row_counter; ?>">                                </td>                                <td>                                    <select class="agent_type" onchange="agent_type_changed(<?= $row_counter ?>)" id="<?= "agent_type_".$row_counter; ?>" name="<?= "agent_type_".$row_counter; ?>">                                        <option value="other_agents">Other Agent</option>                                        <option value="customers">Customer</option>                                        <option value="carriage_contractors">Contractor</option>                                        <option value="companies">Company</option>                                        <option value="" selected>Self</option>                                    </select>                                                <span id="<?= "agent_id_area_".$row_counter; ?>">                                                    <!--here requested agents will fall by ajax dinamically-->                                                </span>                                </td>                                <td><input onkeyup="amount_changed()" onchange="amount_changed()" type="number" step="any" class="amount" name="<?= "amount_".$row_counter; ?>" placeholder="amount.."></td>                                <td>                                    <select class="payment_type" onchange="amount_changed()" name="<?= "payment_type_".$row_counter; ?>">                                        <option value="1">Debit</option>                                        <option value="0">Credit</option>                                    </select>                                </td>                            </tr>                        <?php                        }                        ?>                        </tbody>                        <tfoot>                        <tr style="border-bottom: 0px; display: table-row; font-size: 13px;">                            <td><a style="text-decoration: none; cursor: pointer;" onclick="display_row()"><i class="fa fa-plus-circle"></i> Add Entry</a></td><td><a   style="float: right; cursor: pointer; color: red; text-decoration: none;" onclick="hide_row()"><i class="fa fa-minus-circle"></i> remove</a><input size="2" value="<?= (sizeof($voucher->entries)+1) ?>" type="hidden" id="pannel_count" name="pannel_count"></td>                        </tr>                        </tfoot>                    </table>                </div>            </td>        </tr>        <tr>            <td>                <div class="col-sm-2 text-center" id="balance_area">                    <strong>Balance: </strong><span class="balance" id="voucher_balance"></span>                </div>                <div class="col-sm-8">                    <input type="text" class="form-control" name="voucher_details" value="<?= $voucher->voucher_details; ?>" placeholder="your voucher details... if any" style="width: 100%;">                </div>                <div class="col-sm-2 text-center">                    <input type="submit" name="save_contractor_credit_voucher" value="Save" style="background-color: #31708f; color: #ffffff;">                </div>            </td>        </tr>    </table></div></div></form></div></div>